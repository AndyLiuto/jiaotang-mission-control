<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>ç„¦ç³– Mission Control</title>
    <script>
        const AUTH_CODE = "COOCaramel";
        function checkAuth() {
            const saved = localStorage.getItem("jiaotang_auth");
            if (saved === AUTH_CODE) return;
            const input = prompt("è¯·è¾“å…¥ç„¦ç³–æˆæƒç  (ğŸ®):");
            if (input === AUTH_CODE) {
                localStorage.setItem("jiaotang_auth", AUTH_CODE);
            } else {
                document.body.innerHTML = "<h1 style='padding:50px;text-align:center;'>ğŸ”’ è®¿é—®è¢«æ‹’ç»ã€‚è¯·å‘ç„¦ç³–è·å–æˆæƒç ã€‚</h1>";
                window.stop();
            }
        }
        checkAuth();
    </script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #eef2f1; }
        h1 { color: #d97706; margin-bottom: 30px; font-size: 24px; display: flex; align-items: center; flex-wrap: wrap; }
        h2 { font-size: 18px; border-bottom: 2px solid #f4f7f6; padding-bottom: 10px; margin-top: 0; color: #1f2937; }
        .status { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-live { background: #fee2e2; color: #991b1b; animation: blink 1s infinite; }
        .status-upcoming { background: #dbeafe; color: #1e40af; }
        .status-waiting { background: #fef3c7; color: #92400e; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .section-sub { font-size: 14px; font-weight: bold; color: #9a3412; margin: 15px 0 10px 0; }
        .footer { text-align: center; margin-top: 40px; color: #9ca3af; font-size: 12px; }
        .holding-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .holding-table th { text-align: left; padding: 8px 4px; border-bottom: 2px solid #e5e7eb; color: #6b7280; font-weight: 500; }
        .holding-table td { padding: 8px 4px; border-bottom: 1px solid #f3f4f6; }
        .profit { color: #ef4444; font-weight: bold; }
        .loss { color: #22c55e; font-weight: bold; }
        .total-row { background: #fef3c7; font-weight: bold; }
        .refresh-btn { background: #d97706; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: 10px; }
        .refresh-btn:hover { background: #b45309; }
        .last-update { font-size: 11px; color: #9ca3af; margin-left: 10px; }
        .loading { opacity: 0.5; }
        .team-logo { font-size: 20px; margin-right: 8px; }
        .match-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #e5e7eb; }
        .match-opponent { font-weight: 500; }
        .match-date { font-size: 12px; color: #6b7280; }
        .task-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f9fafb; }
        .task-title { font-weight: 600; display: block; margin-bottom: 4px; }
        .task-meta { font-size: 12px; color: #6b7280; }
        .summary-box { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .summary-total { font-size: 28px; font-weight: bold; }
        .summary-label { font-size: 12px; color: #92400e; }
    </style>
</head>
<body>
    <h1>
        ğŸ® ç„¦ç³– Mission Control 
        <span style="font-size: 12px; background: #fff7ed; padding: 4px 10px; border-radius: 10px; color: #9a3412; margin-left: 10px;">COO æ¨¡å¼</span>
        <button class="refresh-btn" onclick="refreshAll()">ğŸ”„ åˆ·æ–°è¡Œæƒ…</button>
        <span class="last-update" id="lastUpdate">--</span>
    </h1>

    <div class="grid">
        <!-- æŒä»“ç›ˆäº -->
        <div class="card" style="border-left: 4px solid #ef4444;">
            <h2>ğŸ’° æˆ‘çš„æŒä»“ (å®æ—¶)</h2>
            <div class="summary-box">
                <div class="summary-label">æ€»ç›ˆäº</div>
                <div class="summary-total" id="totalPnL">åŠ è½½ä¸­...</div>
                <div class="summary-label">æ€»æˆæœ¬: <span id="totalCost">--</span> | æ€»å¸‚å€¼: <span id="totalValue">--</span></div>
            </div>
            <table class="holding-table">
                <thead>
                    <tr>
                        <th>ä»£ç </th>
                        <th>åç§°</th>
                        <th>æˆæœ¬</th>
                        <th>ç°ä»·</th>
                        <th>æ•°é‡</th>
                        <th>ç›ˆäº</th>
                    </tr>
                </thead>
                <tbody id="holdingBody">
                    <tr><td colspan="6" style="text-align:center;">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- ä½“è‚²ä¸­å¿ƒ -->
        <div class="card" style="border-left: 4px solid #ef4444;">
            <h2>ğŸ† ä½“è‚²ä¸­å¿ƒ</h2>
            
            <div class="section-sub"><span class="team-logo">ğŸ”´</span> é˜¿æ£®çº³ Arsenal</div>
            <div class="match-row">
                <div>
                    <span class="match-opponent">è”èµ›æ¯åŠå†³èµ› vs åˆ‡å°”è¥¿</span>
                    <div class="match-date">Feb 4</div>
                </div>
                <span class="status" style="background:#dcfce7;color:#166534;">W 1-0</span>
            </div>
            <div class="task-meta">ğŸ† æŒºè¿›å†³èµ›ï¼å“ˆå¼—èŒ¨ç»æ€ï¼</div>

            <div class="section-sub"><span class="team-logo">ğŸ”¥</span> å¼€æ‹“è€… Trail Blazers</div>
            <div class="task-item" style="background: #fef3c7; padding: 8px; border-radius: 8px;">
                <span class="task-title">â­ é‡ç‚¹å…³æ³¨ï¼šæ¨æ±‰æ£® Yang Hansen</span>
                <div class="task-meta">ğŸ‡¨ğŸ‡³ ä¸­å›½æ–°ç§€</div>
            </div>
            <div class="match-row">
                <div><span class="match-opponent">vs ç°ç†Š Memphis</span><div class="match-date">Feb 7 14:00 åŒ—äº¬</div></div>
                <span class="status status-upcoming">å³å°†</span>
            </div>
            <div class="match-row">
                <div><span class="match-opponent">vs ç°ç†Š Memphis</span><div class="match-date">Feb 8 14:00 åŒ—äº¬</div></div>
                <span class="status status-upcoming">å³å°†</span>
            </div>

            <div class="section-sub"><span class="team-logo">âš”ï¸</span> XG Xtreme Gaming</div>
            <div class="match-row">
                <div><span class="match-opponent">BLAST Slam VI å°ç»„èµ›</span><div class="match-date">Feb 4-5 å¤šåœº</div></div>
                <span class="status status-live">è¿›è¡Œä¸­</span>
            </div>
        </div>
    </div>

    <div class="footer">
        <span id="syncTime">--</span> | ç„¦ç³–ä¸ºä½ å·¡èˆª ğŸ® | è¡Œæƒ…æ¯60ç§’è‡ªåŠ¨åˆ·æ–°
    </div>

    <script>
        // æŒä»“æ•°æ® (å¯ç¼–è¾‘)
        const portfolio = [
            { code: "601012", name: "éš†åŸºç»¿èƒ½", cost: 18.773, shares: 400, market: "sh" },
            { code: "510310", name: "300ETF", cost: 4.388, shares: 2000, market: "sh" },
            { code: "159887", name: "é“¶è¡ŒETF", cost: 1.263, shares: 2000, market: "sz" },
            { code: "512890", name: "çº¢åˆ©ä½æ³¢ETF", cost: 1.172, shares: 8500, market: "sh" }
        ];

        // è§£æè…¾è®¯è¡Œæƒ…æ•°æ®
        function parseQuote(text, code) {
            const regex = new RegExp(`v_[a-z]{2}${code}="([^"]+)"`);
            const match = text.match(regex);
            if (match) {
                const parts = match[1].split("~");
                return {
                    name: parts[1],
                    price: parseFloat(parts[3]),
                    change: parseFloat(parts[31]),
                    changePercent: parseFloat(parts[32])
                };
            }
            return null;
        }

        // è·å–å®æ—¶è¡Œæƒ…
        async function fetchQuotes() {
            const codes = portfolio.map(p => p.market + p.code).join(",");
            try {
                // ä½¿ç”¨ CORS ä»£ç†
                const proxyUrl = "https://api.allorigins.win/raw?url=";
                const apiUrl = `http://qt.gtimg.cn/q=${codes}`;
                const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
                const text = await response.text();
                
                const quotes = {};
                portfolio.forEach(p => {
                    const quote = parseQuote(text, p.code);
                    if (quote) {
                        quotes[p.code] = quote;
                    }
                });
                return quotes;
            } catch (e) {
                console.error("è·å–è¡Œæƒ…å¤±è´¥:", e);
                return null;
            }
        }

        // æ›´æ–°æŒä»“è¡¨æ ¼
        function updateTable(quotes) {
            const tbody = document.getElementById("holdingBody");
            let html = "";
            let totalCost = 0;
            let totalValue = 0;

            portfolio.forEach(p => {
                const quote = quotes ? quotes[p.code] : null;
                const price = quote ? quote.price : p.cost;
                const costTotal = p.cost * p.shares;
                const valueTotal = price * p.shares;
                const pnl = valueTotal - costTotal;
                const pnlPercent = (pnl / costTotal * 100).toFixed(2);

                totalCost += costTotal;
                totalValue += valueTotal;

                const pnlClass = pnl >= 0 ? "profit" : "loss";
                const pnlSign = pnl >= 0 ? "+" : "";

                html += `<tr>
                    <td>${p.code}</td>
                    <td>${p.name}</td>
                    <td>${p.cost.toFixed(3)}</td>
                    <td>${price.toFixed(3)}</td>
                    <td>${p.shares}</td>
                    <td class="${pnlClass}">${pnlSign}${pnl.toFixed(1)} (${pnlSign}${pnlPercent}%)</td>
                </tr>`;
            });

            tbody.innerHTML = html;

            // æ›´æ–°æ±‡æ€»
            const totalPnL = totalValue - totalCost;
            const totalPnLPercent = (totalPnL / totalCost * 100).toFixed(2);
            const pnlClass = totalPnL >= 0 ? "profit" : "loss";
            const pnlSign = totalPnL >= 0 ? "+" : "";

            document.getElementById("totalPnL").innerHTML = `<span class="${pnlClass}">${pnlSign}${totalPnL.toFixed(1)} (${pnlSign}${totalPnLPercent}%)</span>`;
            document.getElementById("totalCost").textContent = `Â¥${totalCost.toFixed(0)}`;
            document.getElementById("totalValue").textContent = `Â¥${totalValue.toFixed(0)}`;
        }

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAll() {
            document.getElementById("holdingBody").classList.add("loading");
            const quotes = await fetchQuotes();
            if (quotes) {
                updateTable(quotes);
                const now = new Date();
                const timeStr = now.toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
                document.getElementById("lastUpdate").textContent = `æœ€åæ›´æ–°: ${timeStr}`;
                document.getElementById("syncTime").textContent = `æ•°æ®åŒæ­¥äº: ${now.toLocaleDateString("zh-CN")} ${timeStr}`;
            }
            document.getElementById("holdingBody").classList.remove("loading");
        }

        // åˆå§‹åŒ–
        refreshAll();
        // æ¯60ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(refreshAll, 60000);
    </script>
</body>
</html>
